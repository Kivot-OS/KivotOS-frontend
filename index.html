<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KivotOS APT Repository</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles/themes/catppuccin-latte.css" />
    <link rel="stylesheet" href="styles/themes/catppuccin-mocha.css" />
    <link rel="stylesheet" href="styles/base.css" />
    <link rel="stylesheet" href="styles/components.css" />
    <link rel="stylesheet" href="styles/page.css" />
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1>üóÇÔ∏è KivotOS Repository</h1>
        <p class="tagline">Custom APT packages for KivotOS distribution</p>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
          <span class="theme-toggle-slider"></span>
        </button>
      </div>
    </div>

    <div class="main-content">
      <!-- Top Row: Setup + Packages -->
      <div class="dashboard-row primary">
        <div class="dashboard-col-2">
          <div class="card quick-setup">
            <h2><span class="icon">‚ö°</span> Quick Setup</h2>
            <p>Add KivotOS repository to your Debian/Ubuntu system:</p>

            <h3>1. Import repo key</h3>
            <div class="code-block">
              <pre><code id="cmd1">curl -fsSL https://kivot-os.github.io/KivotOS-repo/pubkey.gpg \
| sudo gpg --dearmor -o /usr/share/keyrings/kivotos.gpg</code></pre>
              <button class="copy-btn" onclick="copyCommand('cmd1', this)">
                Copy
              </button>
            </div>

            <h3>2. Add sources list (trixie/main)</h3>
            <div class="code-block">
              <pre><code id="cmd2">echo "deb [arch=amd64 signed-by=/usr/share/keyrings/kivotos.gpg] \
https://kivot-os.github.io/KivotOS-repo/ trixie main" \
| sudo tee /etc/apt/sources.list.d/kivotos.list</code></pre>
              <button class="copy-btn" onclick="copyCommand('cmd2', this)">
                Copy
              </button>
            </div>

            <h3>3. Update & install</h3>
            <div class="code-block">
              <pre><code id="cmd3">sudo apt update
sudo apt install yazi-cli yazi-fm hellwal</code></pre>
              <button class="copy-btn" onclick="copyCommand('cmd3', this)">
                Copy
              </button>
            </div>
          </div>
        </div>

        <div class="dashboard-col-1">
          <div class="card">
            <h2><span class="icon">üì¶</span> Available Packages</h2>
            <div class="package-grid" id="package-grid">
              <div class="loading-message">Loading available packages...</div>
            </div>
            <a href="apt.html" class="browse-btn">Browse APT Repository ‚Üí</a>
          </div>
        </div>
      </div>

      <!-- Bottom Row: Status + Resources -->
      <div class="dashboard-row">
        <div class="dashboard-col-1">
          <div class="card">
            <h2><span class="icon">üìä</span> Repository Status</h2>
            <div class="status-graph">
              <img
                src="https://raw.githubusercontent.com/dungdinhmanh/KivotOS-status/refs/heads/master/graphs/kivot-os-repository/response-time.png"
                alt="KivotOS Repository Response Time Graph"
              />
            </div>
            <div class="status-details">
              <p>
                <strong>Overall uptime:</strong>
                <span id="uptime-status">Loading...</span>
              </p>
              <p>
                <strong>Average response time:</strong>
                <span id="response-time-status">Loading...</span>
              </p>
            </div>
            <div class="cta">
              <a
                href="https://kivot-os.github.io/KivotOS-status/"
                style="color: var(--accent); text-decoration: none"
                >View Full Status Page ‚Üí</a
              >
            </div>
          </div>
        </div>

        <div class="dashboard-col-1">
          <div class="card">
            <h2><span class="icon">üîó</span> Resources</h2>
            <ul style="list-style: none; padding: 0">
              <li style="margin: 0.75rem 0">
                <a
                  href="https://github.com/Kivot-OS/KivotOS-repo"
                  style="color: var(--accent); text-decoration: none"
                >
                  ‚Üí GitHub Repository
                </a>
              </li>
              <li style="margin: 0.75rem 0">
                <a
                  href="./apt/"
                  style="color: var(--accent); text-decoration: none"
                >
                  ‚Üí Browse repository
                </a>
              </li>
              <li style="margin: 0.75rem 0">
                <a
                  href="./pubkey.gpg"
                  style="color: var(--accent); text-decoration: none"
                >
                  ‚Üí Download GPG Public Key
                </a>
              </li>
              <li style="margin: 0.75rem 0">
                <a
                  href="https://github.com/Kivot-OS/KivotOS-repo/actions?query=workflow%3A%22apt-packages%22"
                  style="color: var(--accent); text-decoration: none"
                >
                  ‚Üí Build:
                  <span id="build-status" style="font-weight: 500"
                    >Loading...</span
                  >
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>
        KivotOS Repository ¬∑ Powered by
        <a href="https://pages.github.com">GitHub Pages</a>
      </p>
    </div>

    <script>
      // Theme toggle
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      // Load saved theme
      const savedTheme = localStorage.getItem("theme") || "light";
      html.setAttribute("data-theme", savedTheme);

      themeToggle.addEventListener("click", () => {
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";

        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);

        updateStatusColors();
      });

      // Copy command function
      function copyCommand(id, button) {
        const code = document.getElementById(id);
        const text = code.textContent;

        navigator.clipboard.writeText(text).then(() => {
          button.textContent = "Copied!";
          button.classList.add("copied");

          setTimeout(() => {
            button.textContent = "Copy";
            button.classList.remove("copied");
          }, 2000);
        });
      }

      function updateStatusColors() {
        // Updated to point to Kivot-OS
        const uptimeUrl =
          "https://raw.githubusercontent.com/dungdinhmanh/KivotOS-status/master/api/kivot-os-repository/uptime.json";
        const responseTimeUrl =
          "https://raw.githubusercontent.com/dungdinhmanh/KivotOS-status/master/api/kivot-os-repository/response-time.json";

        const uptimeElement = document.getElementById("uptime-status");
        const responseTimeElement = document.getElementById(
          "response-time-status"
        );
        const currentTheme =
          document.documentElement.getAttribute("data-theme");

        fetch(uptimeUrl)
          .then((response) => response.json())
          .then((data) => {
            if (data && data.message) {
              uptimeElement.textContent = data.message;
              uptimeElement.style.color = data.color || "var(--text-primary)";
            }
          })
          .catch((error) => {
            console.error("Error fetching uptime status:", error);
            uptimeElement.textContent = "N/A";
          });

        fetch(responseTimeUrl)
          .then((response) => response.json())
          .then((data) => {
            if (data && data.message) {
              responseTimeElement.textContent = data.message;
              responseTimeElement.style.color = "var(--ctp-green)"; // Catppuccin Green
            }
          })
          .catch((error) => {
            console.error("Error fetching response time status:", error);
            responseTimeElement.textContent = "N/A";
          });
      }

      updateStatusColors();

      // Format time helper
      function formatBuildTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        // Format time in 24h format
        const time24h = date.toLocaleString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });

        if (diffDays === 0) {
          return `Today at ${time24h}`;
        } else if (diffDays === 1) {
          return `Yesterday at ${time24h}`;
        } else if (diffDays < 7) {
          return `${diffDays} days ago at ${time24h}`;
        } else {
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
        }
      }

      // Cache management for API rate limiting
      const apiCache = {
        build: { data: null, timestamp: 0 },
        status: { data: null, timestamp: 0 },
      };
      const CACHE_DURATION = 60000; // 1 minute cache

      // Fetch GitHub workflow status with caching
      async function updateBuildStatus() {
        const buildStatusElement = document.getElementById("build-status");
        const currentTheme =
          document.documentElement.getAttribute("data-theme");

        // Check cache first
        const now = Date.now();
        if (
          apiCache.build.data &&
          now - apiCache.build.timestamp < CACHE_DURATION
        ) {
          displayBuildStatus(
            apiCache.build.data,
            buildStatusElement,
            currentTheme
          );
          return;
        }

        try {
          // Fetch build status from Kivot-OS/KivotOS-repo
          const response = await fetch(
            "https://api.github.com/repos/Kivot-OS/KivotOS-repo/actions/workflows/apt-packages.yml/runs?per_page=1",
            {
              headers: {
                Accept: "application/vnd.github+json",
                "X-GitHub-Api-Version": "2022-11-28",
              },
            }
          );

          // Check rate limit headers
          const remaining = response.headers.get("x-ratelimit-remaining");
          if (remaining && parseInt(remaining) < 10) {
            console.warn(
              `GitHub API rate limit low: ${remaining} requests remaining`
            );
          }

          const data = await response.json();

          // Update cache
          apiCache.build.data = data;
          apiCache.build.timestamp = now;

          displayBuildStatus(data, buildStatusElement, currentTheme);
        } catch (error) {
          console.error("Error fetching build status:", error);
          buildStatusElement.textContent = "Unavailable";
          buildStatusElement.style.color = "var(--text-secondary)";
        }
      }

      function displayBuildStatus(data, element, theme) {
        if (data.workflow_runs && data.workflow_runs.length > 0) {
          const latestRun = data.workflow_runs[0];
          const status = latestRun.status;
          const conclusion = latestRun.conclusion;
          const timeInfo = formatBuildTime(latestRun.created_at);

          let statusText = "";
          let statusColor = "";

          if (status === "in_progress" || status === "queued") {
            statusText = `Running (${timeInfo})`;
            statusColor = "var(--ctp-yellow)";
          } else if (status === "completed") {
            if (conclusion === "success") {
              statusText = `Passed (${timeInfo})`;
              statusColor = "var(--ctp-green)";
            } else if (conclusion === "failure") {
              statusText = `Failed (${timeInfo})`;
              statusColor = "var(--ctp-red)";
            } else {
              statusText = `Unknown (${timeInfo})`;
              statusColor = "var(--text-secondary)";
            }
          } else {
            statusText = `Pending (${timeInfo})`;
            statusColor = "var(--text-secondary)";
          }

          element.textContent = statusText;
          element.style.color = statusColor;
        } else {
          // If no workflow runs, show as "Not available"
          element.textContent = "No builds found";
          element.style.color = "var(--text-secondary)";
        }
      }

      // Auto-refresh package list from packages.json using GitHub API
      async function updatePackageList() {
        try {
          const container = document.getElementById("package-grid");
          // Fetch packages.json directly from the main branch of the repo
          const response = await fetch(
            "https://raw.githubusercontent.com/Kivot-OS/KivotOS-repo/main/packages.json"
          );

          if (!response.ok) throw new Error("Failed to fetch package list");

          const data = await response.json();
          const packages = data.packages || [];

          container.innerHTML = ""; // Clear loading message

          if (packages.length === 0) {
            container.innerHTML =
              '<div class="loading-message">No packages found</div>';
            return;
          }

          packages.forEach((pkg) => {
            // Try to fetch latest version from repo source if possible,
            // otherwise just show a generic "Latest" badge or type

            const item = document.createElement("div");
            item.className = "package-item";
            item.innerHTML = `
                        <div>
                            <div class="package-name">${pkg.name}</div>
                            <div class="package-desc">${pkg.description}</div>
                        </div>
                        <span class="version-badge" title="Type: ${pkg.type}">
                            ${pkg.type === "custom" ? "latest" : "stable"}
                        </span>
                    `;

            // Add click to open homepage
            item.style.cursor = "pointer";
            item.onclick = () => window.open(pkg.homepage, "_blank");

            container.appendChild(item);
          });
        } catch (error) {
          console.error("Error fetching packages:", error);
          const container = document.getElementById("package-grid");
          container.innerHTML =
            '<div class="loading-message" style="color: var(--ctp-red)">Failed to load packages</div>';
        }
      }

      updateBuildStatus();
      updatePackageList();
    </script>
  </body>
</html>
